---
title: "Hypothesis testing with CLT (cont.)"
subtitle: "Difference in proportions"
date: "October 30, 2024"
title-slide-attributes:
    data-background-image: "figs/bikeshare-plots.png"
    data-background-size: contain
    data-background-opacity: "0.2"
format: 
  revealjs:
    theme: custom.scss
    transition: none
    incremental: true
    scrollable: true
editor: visual
editor_options: 
  chunk_output_type: console
draft: false
---

## Housekeeping

```{r echo = F, message= F}
knitr::opts_chunk$set(echo = F, warning = F, messabundance = F)
library(tidyverse)
library(openintro)
library(readr)
library(kableExtra)
plot_theme <- theme(text = element_text(size = 24))
source("../stat201_fns.R")
```

-   Modified office hours

## Recap

-   


# Test of two proportions

Now suppose we have samples of binary outcomes from two populations.

## Difference of two proportions

Suppose we have two populations 1 and 2, and want to conduct a hypothesis test for the difference in population proportions: $p_{1} - p_{2}$

-   We have samples of size $n_{1}$ and $n_{2}$

-   Reasonable point estimate: $\hat{p}_{1, obs} - \hat{p}_{2,obs}$

-   Apply same process as in previous test for a single proportion, this time working with the sampling distribution of the difference of two sample proportions

## Sampling dist. of difference of two proportions

-   In order to use CLT approximation, we have to ensure conditions are met:

    1.  Independence (extended): data are independent within *and* between groups
    2.  Success-failure (extended): success-failure conditions holds for *both* groups (must perform four total checks)

-   If above hold, then:

::: fragment
$$
\hat{p}_{1} - \hat{p}_{2} \overset{\cdot}{\sim} N\left(p_{1} - p_{2}, \sqrt{\frac{p_{1} (1-p_{1})}{n_{1}} + \frac{p_{2} (1-p_{2})}{n_{2}}} \right)
$$

where $p_{1}$ and $p_{2}$ are the population proportions
:::

## Hypothesis test for difference in proportions

1.  Define hypotheses. Hypothesis tests for difference in proportions in this class will take the form:

::: fragment
$$
\begin{align*}
H_{0}: \ &p_{1} = p_{2} \qquad \Rightarrow \qquad  H_{0}: p_{1} - p_{2} = 0 \\
H_{A}: \ &p_{1} \neq p_{2} \qquad \Rightarrow \qquad  H_{A}: p_{1} - p_{2} \neq 0 \\
\text{ or }\ &p_{1} < p_{2}  \qquad \Rightarrow \qquad   \qquad \  p_{1} - p_{2} < 0 \\
\text{ or }\ &p_{1} > p_{2} \qquad \Rightarrow \qquad   \qquad \  p_{1} - p_{2} > 0
\end{align*}
$$
:::

2.  Collect data/summarise (i.e. obtain $\hat{p}_{1,obs}$ and $\hat{p}_{2,obs}$)

## Pooled proportion

-   To obtain null distribution, we would need to know $p_{1}$ and $p_{2}$ to verify success-failure conditions

-   We obviously don't have these values, so maybe use $\hat{p}_{1,obs}$ and $\hat{p}_{2,obs}$?

-   But wait! If $H_{0}: p_{1} = p_{2}$, then $\hat{p}_{1,obs}$ and $\hat{p}_{2,obs}$ in theory come from the *same* population

    -   So under this null hypothesis, we use a special proportion called the **pooled proportion** to check the success-failure conditions:

::: fragment
$$
\hat{p}_{pooled} = \frac{\text{total # of successes from both samples}}{\text{combined sample size}} = \frac{n_{1} \hat{p}_{1,obs} + n_{2} \hat{p}_{2,obs}}{n_{1} + n_{2}}
$$

-   ::: {style="color: maroon"}
    This is the best estimate of both $p_{1}$ and $p_{2}$ *if null hypothesis of* $p_{1} = p_{2}$ *is true*!
    :::
:::

## Hypothesis test (cont.)

3.  Obtain null distribution (first verify conditions for inference using $\hat{p}_{pooled}$)
    -   If conditions satisfied, then we have the "general" sampling distribution of $\hat{p}_{1} - \hat{p}_{2}$ from previous slide.
    -   But to obtain the **null distribution**, we assume $H_{0}: p_{1} - p_{2} = 0$ is true, and will estimate $p_{1}$ and $p_{2}$ using $\hat{p}_{pooled}$ to approximate standard error:

::: fragment
$$
\begin{align*}
\hat{p}_{1} - \hat{p}_{2} &\overset{\cdot}{\sim} N\left(p_{1} - p_{2}, \sqrt{\frac{p_{1} (1-p_{1})}{n_{1}} + \frac{p_{2} (1-p_{2})}{n_{2}}}  \right) \qquad \text{(CLT)} \\ &\overset{\cdot}{\sim} N\big(0, \underbrace{\sqrt{\frac{\hat{p}_{pooled}(1 - \hat{p}_{pooled})}{n_{1}} + \frac{\hat{p}_{pooled}(1 - \hat{p}_{pooled})}{n_{2}}}}_{\widehat{\text{SE}}_{0}} \big) \qquad (H_{0})
\end{align*}
$$
:::

## Hypothesis test (cont.)

Obtain test-statistic:

$$
z = \frac{\text{point estimate} - \text{null value}}{\text{SE}} \approx \frac{(\hat{p}_{1,obs} - \hat{p}_{2,obs}) - 0}{\widehat{\text{SE}}_{0}}
$$

-   To obtain p-value, we want $\text{Pr}(Z \geq z)$ and/or $\text{Pr}(Z \leq z)$ where $Z \sim N(0,1)$

    -   Obtain using `pnorm(z, 0, 1)`
